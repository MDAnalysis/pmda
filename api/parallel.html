
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2.1.1. Parallel Analysis building blocks — pmda.parallel &#8212; PMDA 0.3.0+3.g26eb31e documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within PMDA 0.3.0+3.g26eb31e documentation"
          href="../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../_static/mdanalysis-logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2.1.2. Parallel Analysis helper — pmda.custom" href="custom.html" />
    <link rel="prev" title="2. API for pmda" href="../api.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <span class="target" id="module-pmda.parallel"></span><div class="section" id="parallel-analysis-building-blocks-pmda-parallel">
<h1><span class="section-number">2.1.1. </span>Parallel Analysis building blocks — <a class="reference internal" href="#module-pmda.parallel" title="pmda.parallel"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda.parallel</span></code></a><a class="headerlink" href="#parallel-analysis-building-blocks-pmda-parallel" title="Permalink to this headline">¶</a></h1>
<p>A collection of useful building blocks for creating Analysis
classes.</p>
<dl class="class">
<dt id="pmda.parallel.ParallelAnalysisBase">
<em class="property">class </em><code class="sig-prename descclassname">pmda.parallel.</code><code class="sig-name descname">ParallelAnalysisBase</code><span class="sig-paren">(</span><em class="sig-param">universe</em>, <em class="sig-param">atomgroups</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pmda/parallel.html#ParallelAnalysisBase"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pmda.parallel.ParallelAnalysisBase" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for defining parallel multi frame analysis</p>
<p>The class it is designed as a template for creating multiframe analyses.
This class will automatically take care of setting up the trajectory
reader for iterating in parallel.</p>
<p>To parallelize the analysis <code class="docutils literal notranslate"><span class="pre">ParallelAnalysisBase</span></code> separates the
trajectory into work blocks containing multiple frames. The number of
blocks is equal to the number of available cores or dask workers. This
minimizes the number of python processes that are started during a
calculation. Accumulation of frames within a block happens in the
<cite>self._reduce</cite> function. A consequence when using dask is that adding
additional workers during a computation will not result in an reduction
of run-time.</p>
<p>To define a new Analysis,
<a class="reference internal" href="#pmda.parallel.ParallelAnalysisBase" title="pmda.parallel.ParallelAnalysisBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">ParallelAnalysisBase</span></code></a> needs to be
subclassed and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">_single_frame()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">_conclude()</span></code> must be
defined. It is also possible to define
<code class="xref py py-meth docutils literal notranslate"><span class="pre">_prepare()</span></code> for
pre-processing and <code class="xref py py-meth docutils literal notranslate"><span class="pre">_reduce()</span></code>
for custom reduce operation on the work blocks. See the example below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewAnalysis</span><span class="p">(</span><span class="n">ParallelAnalysisBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomgroup</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="n">atomgroup</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewAnalysis</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">atomgroup</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">agroups</span><span class="p">):</span>
        <span class="c1"># REQUIRED</span>
        <span class="c1"># called for every frame. ``ts`` contains the current time step</span>
        <span class="c1"># and ``agroups`` a tuple of atomgroups that are updated to the</span>
        <span class="c1"># current frame. Return result of `some_function` for a single</span>
        <span class="c1"># frame</span>
        <span class="k">return</span> <span class="n">some_function</span><span class="p">(</span><span class="n">agroups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_conclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># REQUIRED</span>
        <span class="c1"># Called once iteration on the trajectory is finished. Results</span>
        <span class="c1"># for each frame are stored in ``self._results`` in a per block</span>
        <span class="c1"># basis. Here those results should be moved and reshaped into a</span>
        <span class="c1"># sensible new variable.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">)</span>
        <span class="c1"># Apply normalisation and averaging to results here if wanted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">result_single_frame</span><span class="p">):</span>
        <span class="c1"># NOT REQUIRED</span>
        <span class="c1"># Called for every frame. ``res`` contains all the results</span>
        <span class="c1"># before current time step, and ``result_single_frame`` is the</span>
        <span class="c1"># result of self._single_frame for the current time step. The</span>
        <span class="c1"># return value is the updated ``res``. The default is to append</span>
        <span class="c1"># results to a python list. This approach is sufficient for</span>
        <span class="c1"># time-series data.</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_single_frame</span><span class="p">)</span>
        <span class="c1"># This is not suitable for every analysis. To add results over</span>
        <span class="c1"># multiple frames this function can be overwritten. The default</span>
        <span class="c1"># value for ``res`` is an empty list. Here we change the type to</span>
        <span class="c1"># the return type of `self._single_frame`. Afterwards we can</span>
        <span class="c1"># safely use addition to accumulate the results.</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">result_single_frame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">result_single_frame</span>
        <span class="c1"># If you overwrite this function *always* return the updated</span>
        <span class="c1"># ``res`` at the end.</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>Afterwards the new analysis can be run like this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">na</span> <span class="o">=</span> <span class="n">NewAnalysis</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;name CA&#39;</span><span class="p">),</span> <span class="mi">35</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">na</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>Universe</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">Universe</span></code>) – a <code class="xref py py-class docutils literal notranslate"><span class="pre">MDAnalysis.core.groups.Universe</span></code> (the
<cite>atomgroups</cite> must belong to this Universe)</p></li>
<li><p><strong>atomgroups</strong> (tuple of <a class="reference external" href="https://www.mdanalysis.org/docs/documentation_pages/core/groups.html#MDAnalysis.core.groups.AtomGroup" title="(in MDAnalysis v0.20)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AtomGroup</span></code></a>) – atomgroups that are iterated in parallel</p></li>
</ul>
</dd>
</dl>
<dl class="attribute">
<dt id="pmda.parallel.ParallelAnalysisBase._results">
<code class="sig-name descname">_results</code><a class="headerlink" href="#pmda.parallel.ParallelAnalysisBase._results" title="Permalink to this definition">¶</a></dt>
<dd><p>The raw data from each process are stored as a list of
lists, with each sublist containing the return values from
<code class="xref py py-meth docutils literal notranslate"><span class="pre">pmda.parallel.ParallelAnalysisBase._single_frame()</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.8)">list</a></p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.ParallelAnalysisBase.readonly_attributes">
<code class="sig-name descname">readonly_attributes</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pmda/parallel.html#ParallelAnalysisBase.readonly_attributes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pmda.parallel.ParallelAnalysisBase.readonly_attributes" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the attributes of this class to be read only</p>
<p>Useful to avoid the class being modified when passing it around.</p>
<p>To be used as a context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">analysis</span><span class="o">.</span><span class="n">readonly_attributes</span><span class="p">():</span>
    <span class="n">some_function</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.ParallelAnalysisBase.run">
<code class="sig-name descname">run</code><span class="sig-paren">(</span><em class="sig-param">start=None</em>, <em class="sig-param">stop=None</em>, <em class="sig-param">step=None</em>, <em class="sig-param">n_jobs=1</em>, <em class="sig-param">n_blocks=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pmda/parallel.html#ParallelAnalysisBase.run"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pmda.parallel.ParallelAnalysisBase.run" title="Permalink to this definition">¶</a></dt>
<dd><p>Perform the calculation</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>start</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a><em>, </em><em>optional</em>) – start frame of analysis</p></li>
<li><p><strong>stop</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a><em>, </em><em>optional</em>) – stop frame of analysis</p></li>
<li><p><strong>step</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a><em>, </em><em>optional</em>) – number of frames to skip between each analysed frame</p></li>
<li><p><strong>n_jobs</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a><em>, </em><em>optional</em>) – number of jobs to start, if <cite>-1</cite> use number of logical cpu cores.
This argument will be ignored when the distributed scheduler is
used</p></li>
<li><p><strong>n_blocks</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.8)"><em>int</em></a><em>, </em><em>optional</em>) – number of blocks to divide trajectory into. If <code class="docutils literal notranslate"><span class="pre">None</span></code> set equal
to n_jobs or number of available workers in scheduler.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="pmda.parallel.Timing">
<em class="property">class </em><code class="sig-prename descclassname">pmda.parallel.</code><code class="sig-name descname">Timing</code><span class="sig-paren">(</span><em class="sig-param">io</em>, <em class="sig-param">compute</em>, <em class="sig-param">total</em>, <em class="sig-param">universe</em>, <em class="sig-param">prepare</em>, <em class="sig-param">conclude</em>, <em class="sig-param">wait=None</em>, <em class="sig-param">io_block=None</em>, <em class="sig-param">compute_block=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pmda/parallel.html#Timing"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pmda.parallel.Timing" title="Permalink to this definition">¶</a></dt>
<dd><p>store various timeing results of obtained during a parallel analysis run</p>
<dl class="method">
<dt id="pmda.parallel.Timing.compute">
<em class="property">property </em><code class="sig-name descname">compute</code><a class="headerlink" href="#pmda.parallel.Timing.compute" title="Permalink to this definition">¶</a></dt>
<dd><p>compute time per frame</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.compute_block">
<em class="property">property </em><code class="sig-name descname">compute_block</code><a class="headerlink" href="#pmda.parallel.Timing.compute_block" title="Permalink to this definition">¶</a></dt>
<dd><p>compute time per block</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.conclude">
<em class="property">property </em><code class="sig-name descname">conclude</code><a class="headerlink" href="#pmda.parallel.Timing.conclude" title="Permalink to this definition">¶</a></dt>
<dd><p>time to conclude</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.cumulate_time">
<em class="property">property </em><code class="sig-name descname">cumulate_time</code><a class="headerlink" href="#pmda.parallel.Timing.cumulate_time" title="Permalink to this definition">¶</a></dt>
<dd><p>cumulative time of io and compute for each frame. This isn’t equal to
<cite>self.total / n_jobs</cite> because <cite>self.total</cite> also includes the scheduler
overhead</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.io">
<em class="property">property </em><code class="sig-name descname">io</code><a class="headerlink" href="#pmda.parallel.Timing.io" title="Permalink to this definition">¶</a></dt>
<dd><p>io time per frame</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.io_block">
<em class="property">property </em><code class="sig-name descname">io_block</code><a class="headerlink" href="#pmda.parallel.Timing.io_block" title="Permalink to this definition">¶</a></dt>
<dd><p>io time per block</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.prepare">
<em class="property">property </em><code class="sig-name descname">prepare</code><a class="headerlink" href="#pmda.parallel.Timing.prepare" title="Permalink to this definition">¶</a></dt>
<dd><p>time to prepare</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.total">
<em class="property">property </em><code class="sig-name descname">total</code><a class="headerlink" href="#pmda.parallel.Timing.total" title="Permalink to this definition">¶</a></dt>
<dd><p>wall time</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.universe">
<em class="property">property </em><code class="sig-name descname">universe</code><a class="headerlink" href="#pmda.parallel.Timing.universe" title="Permalink to this definition">¶</a></dt>
<dd><p>time to create a universe for each block</p>
</dd></dl>

<dl class="method">
<dt id="pmda.parallel.Timing.wait">
<em class="property">property </em><code class="sig-name descname">wait</code><a class="headerlink" href="#pmda.parallel.Timing.wait" title="Permalink to this definition">¶</a></dt>
<dd><p>time for blocks to start working</p>
</dd></dl>

</dd></dl>

</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logos/pmda-logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">PMDA</h1>
    
  </a>
</p>



<p class="blurb">Parallel Molecular Dynamics Analysis</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../userguide.html">1. User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api.html">2. API for <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda</span></code></a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../api.html#building-blocks">2.1. Building blocks</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.1.1. Parallel Analysis building blocks — <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda.parallel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="custom.html">2.1.2. Parallel Analysis helper — <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda.custom</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="util.html">2.1.3. Utility functions — <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda.util</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#pre-defined-parallel-analysis-tasks">2.2. Pre-defined parallel analysis tasks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">3. References</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://www.mdanalysis.org">MDAnalysis</a></li>
    
    <li class="toctree-l1"><a href="https://dask.org">Dask</a></li>
    
    <li class="toctree-l1"><a href="https://distributed.readthedocs.io/">distributed</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../api.html"><span class="section-number">2. </span>API for <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda</span></code></a><ul>
      <li>Previous: <a href="../api.html" title="previous chapter"><span class="section-number">2. </span>API for <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda</span></code></a></li>
      <li>Next: <a href="custom.html" title="next chapter"><span class="section-number">2.1.2. </span>Parallel Analysis helper — <code class="xref py py-mod docutils literal notranslate"><span class="pre">pmda.custom</span></code></a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Max Linke, Oliver Beckstein, Shujie Fan, Richard J. Gowers, Ioannis Paraskevakos, Michael Gecht, Nikolaus Awtrey.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/api/parallel.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/MDAnalysis/pmda" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>